<!DOCTYPE html>
<html lang="en">
<head>
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-TCW5J75HN1"></script>
   <script>
   window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TCW5J75HN1');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dan Calandriello - Naperville Fishing Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #059669; /* Emerald 600 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Emerald 50 */
        }
        .report-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: var(--primary-color);
            margin-top: 1rem;
            border-bottom: 2px solid #a7f3d0; /* Emerald 200 */
            padding-bottom: 0.25rem;
        }
        .report-section p, .report-section ul, .report-section li {
            font-size: 1rem;
            color: #374151; /* Gray 700 */
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .report-section ul {
            list-style: disc;
            padding-left: 1.5rem;
        }
        .report-section strong {
            font-weight: 600;
        }
        .loading-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 flex flex-col items-center">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 md:p-8">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center justify-center" style="font-size:22px;">
                <span class="mr-2 text-emerald-600">
                    <i data-lucide="fish" class="w-7 h-7"></i>
                </span>
                Dan Calandriello's Naperville Angler Pro
            </h1>
            <p class="text-gray-500 mt-2 text-sm">Real-time fishing intelligence for the Naperville, IL area.</p>
        </header>

        <div class="space-y-4 mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
            <label for="fishing-spot" class="block text-sm font-medium text-gray-700">Select a Fishing Spot in or around Naperville, IL:</label>
            <select id="fishing-spot" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm transition duration-150 ease-in-out">
                </select>
            <button id="generate-report-btn"
                class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed"
                type="button">
                <i data-lucide="search" class="w-5 h-5 mr-2"></i>
                Generate Fishing Report
            </button>
        </div>

        <div id="report-container" class="mt-8">
            <div id="loading-state" class="hidden text-center p-8 bg-gray-50 rounded-xl shadow-inner">
                <i data-lucide="loader-circle" class="loading-icon w-8 h-8 text-emerald-600 mx-auto mb-3"></i>
                <p class="text-gray-600 font-semibold" id="loading-text">Generating detailed report...</p>
                <p class="text-xs text-gray-400 mt-1" id="loading-subtext">Fetching current conditions and seasonal advice.</p>
            </div>

            <div id="initial-message" class="text-center p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <i data-lucide="info" class="w-6 h-6 text-blue-600 mx-auto mb-3"></i>
                <p class="text-blue-700">Select a location above and click 'Generate Fishing Report' to get started!</p><br>
                <p class="text-blue-700">Dan Calandriello ©2025</p>
            </div>

            <div id="report-output" class="hidden report-section p-6 bg-white border border-gray-200 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Fishing Report</h2>
                <div id="report-content" class="min-h-[100px] text-gray-700 space-y-3">
                    </div>
                
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <a id="directions-link" href="#" target="_blank" rel="noopener noreferrer" 
                       class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        <i data-lucide="map" class="w-5 h-5 mr-2"></i>
                        Get Google Maps Directions
                    </a>
                </div>
                <div id="sources-container" class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-xs font-semibold text-gray-500 mb-2">To get a report on a second location, just use the drop down menu to select a new location and click "Generate Fishing Report".<br><br>Dan Calandriello ©2025</p>
                    <ul id="sources-list" class="text-xs text-gray-500 space-y-1">
                        </ul>
                </div>
            </div>

            <div id="error-message" class="hidden text-center p-6 bg-red-100 border border-red-300 rounded-lg mt-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 mx-auto mb-3"></i>
                <p id="error-text" class="text-red-700 font-medium"></p> <p class="text-xs text-red-500 mt-1">Check the console for technical details.</p>
            </div>
        </div>

    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-40"></div>
    <div id="alert-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all duration-300 scale-100">
            <div class="text-center">
                <i data-lucide="alert-circle" class="w-8 h-8 text-yellow-500 mx-auto mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title"></h3>
                <p class="mt-2 text-sm text-gray-500" id="modal-body"></p>
            </div>
            <div class="mt-4 flex justify-center">
                <button type="button" onclick="closeModal()"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:text-sm">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Global Variables and Configuration ---
        const FISHING_SPOTS = [
            "Arrowhead Pond Park, (Bolingbrook, Illinois)",
            "Blackhawk Pond Park, (Bolingbrook Illinois)",
            "DuPage Riverwalk Piers (Naperville) Quarry Lake",
            "Goose Lake Park 95th Street Naperville Il",
            "Herrick Lake in Warrenville, IL",
            "Hidden Lake Forest Preserve (Eagle/Round Meadow Lake)",
            "Hidden Lakes Trout Farm (Bolingbrook, Illinois)",
            "Hobson West Ponds Naperville Illinois",
            "Lake Osbourne Naperville Illinois",
            "Lake Renwick Preserve in Plainfield, Illinois",
            "Pathways Pond (Bolingbrook, Illinois)",
            "Silver Lake, Sand Pond (Blackwell Forest Preserve, Warrenville, Il)",
            "Tall Grass Lakes Ponds",
            "West Branch DuPage River (McDowell Grove area)",
            "Whalon Lake (Naperville/Bolingbrook)",
            "Winding Creek Park Pond, Naperville Illinois",
        ];
        
        // --- MODEL SELECTION ---
        // Returning to Gemini 2.0 Flash because we confirmed it connects (429 is better than 404)
        const MODEL_NAME = "gemini-2.0-flash";
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

        // !!! YOUR NEW API KEY !!!
        const apiKey = "AIzaSyDliq-jFo4Kl7QRfezPc8L8ktRJxYadUEU"; 
        
        // --- DOM Elements ---
        const spotSelect = document.getElementById('fishing-spot');
        const generateBtn = document.getElementById('generate-report-btn');
        const loadingState = document.getElementById('loading-state');
        const loadingText = document.getElementById('loading-text');
        const loadingSubtext = document.getElementById('loading-subtext');
        const initialMessage = document.getElementById('initial-message');
        const reportOutput = document.getElementById('report-output');
        const reportContent = document.getElementById('report-content');
        const sourcesList = document.getElementById('sources-list');
        const errorMessageDiv = document.getElementById('error-message');
        const errorMessageP = document.getElementById('error-text'); 
        const directionsLink = document.getElementById('directions-link');

        // --- Utility Functions ---

        /** Shows a custom modal alert instead of window.alert */
        window.showModal = (title, body) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('alert-modal').classList.remove('hidden');
            document.getElementById('modal-backdrop').classList.remove('hidden');
        };

        /** Closes the custom modal alert */
        window.closeModal = () => {
            document.getElementById('alert-modal').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.add('hidden');
        };

        /** Clears the report and error areas */
        const clearReports = () => {
            reportOutput.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            errorMessageP.textContent = ''; 
            reportContent.innerHTML = '';
            sourcesList.innerHTML = '';
        }

        /** Converts markdown to basic HTML for display */
        const markdownToHtml = (markdown) => {
            let html = markdown;
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
            html = html.replace(/^(<li>.*<\/li>)$/gms, '<ul>$1</ul>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\$(.*?)\$/g, '$1');
            html = html.replace(/\\(circ|degree|text|unit)\{?([F C \s]*)?\}?/gi, (match, p1, p2) => {
                if (p1.toLowerCase() === 'circ' || p1.toLowerCase() === 'degree') { return '°' + (p2 ? p2.trim() : ''); }
                return p2 ? p2.trim() : ''; 
            });
            html = html.replace(/\\circ/g, '°');
            html = html.replace(/[\^_]\{([^{}]*)\}/g, '$1'); 
            html = html.split('\n\n').map(p => p.trim() ? `<p>${p.trim()}</p>` : '').join('');
            html = html.replace(/\n/g, ''); 
            html = html.replace(/<\/p><ul>/g, '<ul>').replace(/<\/ul><p>/g, '</ul>');
            html = html.replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>');
            return html;
        };
        
        // --- FIXED: Reliable Universal Google Maps URL ---
        const generateDirectionsLink = (destination) => {
            const encodedDestination = encodeURIComponent(destination);
            // This format works on all devices and forces a search
            return `https://www.google.com/maps/search/?api=1&query={encodedDestination}`;
        }

        /**
         * Calls the Gemini API with SMART RETRY logic.
         */
        const callGeminiAPI = async (prompt, systemInstruction) => {
            const maxRetries = 5;
            let delay = 3000; // Start with 3 seconds
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "googleSearch": {} }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Update Loading UI if we are retrying
                    if (i > 0) {
                        loadingText.textContent = `Google limit hit. Cooling down...`;
                        loadingSubtext.textContent = `Attempt ${i+1}/${maxRetries} (Waiting ${delay/1000}s)`;
                    }

                    const response = await fetch(`${API_BASE_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // --- HANDLE ERRORS ---
                    if (!response.ok) {
                        const status = response.status;
                        
                        // IF RATE LIMITED (429) -> WAIT AND RETRY
                        if (status === 429 || status === 503) {
                            console.warn(`Rate limit hit (429). Waiting ${delay}ms...`);
                            if (i < maxRetries - 1) {
                                await new Promise(resolve => setTimeout(resolve, delay));
                                delay *= 1.5; // Increase wait time
                                continue; // Retry loop
                            } else {
                                throw new Error("Google's free server is too busy. Please wait 1 minute and try again.");
                            }
                        }

                        // IF OTHER ERROR (400, 403, 404) -> FAIL IMMEDIATELY
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${status} - ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    // --- SUCCESS ---
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    } else {
                        throw new Error("Received an empty response from the AI.");
                    }

                } catch (error) {
                    console.error("Gemini API attempt failed:", error);
                    if (i === maxRetries - 1) throw error;
                }
            }
        };


        // --- Main Application Logic ---

        const initApp = async () => { 
            spotSelect.innerHTML = FISHING_SPOTS.map(spot => `<option value="${spot}">${spot}</option>`).join('');
            generateBtn.addEventListener('click', generateReport);
            lucide.createIcons();
        };

        const generateReport = async () => {
            const selectedSpot = spotSelect.value;
            if (!selectedSpot) {
                showModal("Selection Required", "Please select a fishing spot.");
                return;
            }

            clearReports();
            initialMessage.classList.add('hidden');
            reportOutput.classList.add('hidden');
            loadingState.classList.remove('hidden');
            
            // Reset loading text
            loadingText.textContent = "Generating detailed report...";
            loadingSubtext.textContent = "Fetching current conditions and seasonal advice.";
            
            generateBtn.disabled = true;
            directionsLink.classList.add('hidden');

            const systemPrompt = "You are a local Illinois fishing expert providing an advisory report. Analyze information and provide a concise, structured report in plain Markdown format using the following headings: '### Current Weather & Conditions', '### Primary Fish Species', '### Recommended Baits for November', and '### Estimated Water Depth/Characteristics'. Do not use conversational filler or intros. Only output the Markdown content.";
            
            const now = new Date();
            const currentMonth = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            
            const userQuery = `Provide a detailed fishing report for the spot: "${selectedSpot}" near Naperville, Illinois. The current month is ${currentMonth}. The report MUST include the following structured sections: 'Current Weather & Conditions', 'Primary Fish Species', 'Recommended Baits for ${currentMonth}', and 'Estimated Water Depth/Characteristics'. Use information grounded in real-time search results.`;

            try {
                const { text, sources } = await callGeminiAPI(userQuery, systemPrompt);

                reportContent.innerHTML = markdownToHtml(text);
                
                if (sources && sources.length > 0) {
                     sourcesList.innerHTML = sources.map((source, index) => `
                        <li><a href="${source.uri}" target="_blank" class="text-emerald-600 hover:underline">${index + 1}. ${source.title}</a></li>
                    `).join('');
                } else {
                     sourcesList.innerHTML = '<li>No external sources cited.</li>';
                }
                
                reportOutput.classList.remove('hidden');
                directionsLink.href = generateDirectionsLink(selectedSpot);
                directionsLink.classList.remove('hidden'); 

            } catch (error) {
                console.error("Report Generation Failed:", error);
                errorMessageP.textContent = `${error.message}`;
                errorMessageDiv.classList.remove('hidden');
                reportOutput.classList.add('hidden');
            } finally {
                loadingState.classList.add('hidden');
                generateBtn.disabled = false;
                initialMessage.classList.add('hidden');
                lucide.createIcons(); 
            }
        };

        window.onload = initApp; 

    </script>
</body>
</html>
