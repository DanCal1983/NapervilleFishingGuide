<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dan Calandriello - Naperville Fishing Guide</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #059669; /* Emerald 600 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Emerald 50 */
        }
        .report-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: var(--primary-color);
            margin-top: 1rem;
            border-bottom: 2px solid #a7f3d0; /* Emerald 200 */
            padding-bottom: 0.25rem;
        }
        .report-section p, .report-section ul, .report-section li {
            font-size: 1rem;
            color: #374151; /* Gray 700 */
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .report-section ul {
            list-style: disc;
            padding-left: 1.5rem;
        }
        .report-section strong {
            font-weight: 600;
        }
        .loading-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 flex flex-col items-center">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 md:p-8">
        <!-- Header -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center justify-center">
                <span class="mr-2 text-emerald-600">
                    <i data-lucide="sailboat" class="w-7 h-7"></i>
                </span>
                Dan Calandriello's Naperville Angler Pro
            </h1>
            <p class="text-gray-500 mt-2 text-sm">Real-time fishing intelligence powered by Gemini.</p>
        </header>

        <!-- Selection Area -->
        <div class="space-y-4 mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
            <label for="fishing-spot" class="block text-sm font-medium text-gray-700">Select a Fishing Spot near Naperville, IL:</label>
            <select id="fishing-spot" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm transition duration-150 ease-in-out">
                <!-- Options populated by JS -->
            </select>
            <button id="generate-report-btn"
                class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed"
                type="button">
                <i data-lucide="search" class="w-5 h-5 mr-2"></i>
                Generate Fishing Report
            </button>
        </div>

        <!-- Report Display Area -->
        <div id="report-container" class="mt-8">
            <div id="loading-state" class="hidden text-center p-8 bg-gray-50 rounded-xl shadow-inner">
                <i data-lucide="loader-circle" class="loading-icon w-8 h-8 text-emerald-600 mx-auto mb-3"></i>
                <p class="text-gray-600 font-semibold">Generating detailed report... Please wait.</p>
                <p class="text-xs text-gray-400 mt-1">Fetching current conditions and seasonal advice.</p>
            </div>

            <div id="initial-message" class="text-center p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <i data-lucide="info" class="w-6 h-6 text-blue-600 mx-auto mb-3"></i>
                <p class="text-blue-700">Select a location above and click 'Generate Fishing Report' to get started!</p>
            </div>

            <div id="report-output" class="hidden report-section p-6 bg-white border border-gray-200 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Fishing Report</h2>
                <div id="report-content" class="min-h-[100px] text-gray-700 space-y-3">
                    <!-- Report content will be injected here -->
                </div>

                <!-- Sources -->
                <div id="sources-container" class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-xs font-semibold text-gray-500 mb-2">Sources:</p>
                    <ul id="sources-list" class="text-xs text-gray-500 space-y-1">
                        <!-- Sources will be injected here -->
                    </ul>
                </div>
            </div>

            <div id="error-message" class="hidden text-center p-6 bg-red-100 border border-red-300 rounded-lg mt-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 mx-auto mb-3"></i>
                <p class="text-red-700 font-medium"></p>
                <p class="text-xs text-red-500 mt-1">Check the console for technical details.</p>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-40"></div>
    <div id="alert-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all duration-300 scale-100">
            <div class="text-center">
                <i data-lucide="alert-circle" class="w-8 h-8 text-yellow-500 mx-auto mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title"></h3>
                <p class="mt-2 text-sm text-gray-500" id="modal-body"></p>
            </div>
            <div class="mt-4 flex justify-center">
                <button type="button" onclick="closeModal()"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:text-sm">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables and Configuration ---
        const FISHING_SPOTS = [
            "Whalon Lake (Naperville/Bolingbrook)",
            "West Branch DuPage River (McDowell Grove area)",
            "Hidden Lake Forest Preserve (Eagle/Round Meadow Lake)",
            "Tall Grass Lakes Ponds",
            "DuPage Riverwalk Piers (Naperville)",
            "Silver Lake (Blackwell Forest Preserve)",
        ];
        
        // Gemini API Configuration
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

        // Firebase Setup
        let db;
        let auth;
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const spotSelect = document.getElementById('fishing-spot');
        const generateBtn = document.getElementById('generate-report-btn');
        const loadingState = document.getElementById('loading-state');
        const initialMessage = document.getElementById('initial-message');
        const reportOutput = document.getElementById('report-output');
        const reportContent = document.getElementById('report-content');
        const sourcesList = document.getElementById('sources-list');
        const errorMessageDiv = document.getElementById('error-message');
        const errorMessageP = errorMessageDiv.querySelector('p:first-child');
        
        // --- Utility Functions ---

        /** Shows a custom modal alert instead of window.alert */
        window.showModal = (title, body) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('alert-modal').classList.remove('hidden');
            document.getElementById('modal-backdrop').classList.remove('hidden');
        };

        /** Closes the custom modal alert */
        window.closeModal = () => {
            document.getElementById('alert-modal').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.add('hidden');
        };

        /** Clears the report and error areas */
        const clearReports = () => {
            reportOutput.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            errorMessageP.textContent = '';
            reportContent.innerHTML = '';
            sourcesList.innerHTML = '';
        }

        /** Converts markdown to basic HTML for display */
        const markdownToHtml = (markdown) => {
            let html = markdown;
            
            // Convert headers (assuming level 3 for sections)
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            
            // Convert unordered lists
            html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
            html = html.replace(/^(<li>.*<\/li>)$/gms, '<ul>$1</ul>');
            
            // Convert bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert newlines to paragraphs
            html = html.split('\n\n').map(p => p.trim() ? `<p>${p.trim()}</p>` : '').join('');
            
            // Remove remaining single newlines that aren't paragraph breaks
            html = html.replace(/\n/g, ''); 

            // Clean up <ul>/<li> nesting issues from multi-step conversion
            html = html.replace(/<\/p><ul>/g, '<ul>').replace(/<\/ul><p>/g, '</ul>');
            html = html.replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>');
            
            return html;
        };

        /**
         * Calls the Gemini API with exponential backoff and search grounding.
         * @param {string} prompt The user query for the model.
         * @param {string} systemInstruction The role/persona for the model.
         * @returns {Promise<{text: string, sources: Array<{uri: string, title: string}>}>}
         */
        const callGeminiAPI = async (prompt, systemInstruction) => {
            const maxRetries = 5;
            let delay = 1000;
            const apiKey = ""; // Canvas provides API key at runtime

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${API_BASE_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };
                    } else {
                        throw new Error("Received an empty or malformed response from the model.");
                    }

                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (i === maxRetries - 1) {
                        throw new Error("Failed to connect to the fishing intelligence system. Please try again later.");
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        };


        // --- Main Application Logic ---

        /** Initializes Firebase, populates the spot list, and sets up listeners. */
        const initializeApp = async () => {
            // Populate select box
            spotSelect.innerHTML = FISHING_SPOTS.map(spot => 
                `<option value="${spot}">${spot}</option>`
            ).join('');
            
            // Initialize Firebase services
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error');
            }

            // Authentication
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                showModal("Authentication Error", "Could not sign in to Firebase. Data persistence may not work.");
            }
            
            // Set up Auth Listener (though we aren't using Firestore for this app, it's good practice)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    userId = crypto.randomUUID(); // Fallback for unauthenticated/anonymous
                }
                console.log("Current user ID:", userId);
            });

            // Set up event listener
            generateBtn.addEventListener('click', generateReport);
            
            // Initialize icons
            lucide.createIcons();
        };

        /** Handles the full report generation process. */
        const generateReport = async () => {
            const selectedSpot = spotSelect.value;
            if (!selectedSpot) {
                showModal("Selection Required", "Please select a fishing spot before generating a report.");
                return;
            }

            // 1. Set UI to Loading State
            clearReports();
            initialMessage.classList.add('hidden');
            reportOutput.classList.add('hidden');
            loadingState.classList.remove('hidden');
            generateBtn.disabled = true;

            const systemPrompt = "You are a local Illinois fishing expert providing an advisory report. Analyze information and provide a concise, structured report in plain Markdown format using the following headings: '### Current Weather & Conditions', '### Primary Fish Species', '### Recommended Baits for November', and '### Estimated Water Depth/Characteristics'. Do not use conversational filler or intros. Only output the Markdown content.";
            
            // Determine current month dynamically, but since this is a static script, I'll use a specific month for consistency in the prompt.
            const currentMonth = "November 2025"; 
            
            const userQuery = `Provide a detailed fishing report for the spot: "${selectedSpot}" near Naperville, Illinois. The current month is ${currentMonth}. The report MUST include the following structured sections: 'Current Weather & Conditions', 'Primary Fish Species', 'Recommended Baits for November', and 'Estimated Water Depth/Characteristics'. Use information grounded in real-time search results.`;

            try {
                // 2. Call Gemini API
                const { text, sources } = await callGeminiAPI(userQuery, systemPrompt);

                // 3. Update UI with Report
                reportContent.innerHTML = markdownToHtml(text);
                
                // 4. Display Sources
                sourcesList.innerHTML = sources.map((source, index) => `
                    <li>
                        <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-emerald-600 hover:text-emerald-800 hover:underline">
                            ${index + 1}. ${source.title}
                        </a>
                    </li>
                `).join('');
                
                reportOutput.classList.remove('hidden');

            } catch (error) {
                // 5. Handle Errors
                console.error("Report Generation Failed:", error);
                errorMessageP.textContent = `Error: ${error.message}`;
                errorMessageDiv.classList.remove('hidden');
                reportOutput.classList.add('hidden');
            } finally {
                // 6. Reset UI State
                loadingState.classList.add('hidden');
                generateBtn.disabled = false;
                initialMessage.classList.add('hidden');
                lucide.createIcons(); // Re-create icons for dynamic content
            }
        };

        // Initialize on load
        window.onload = initializeApp;

    </script>
</body>
</html>